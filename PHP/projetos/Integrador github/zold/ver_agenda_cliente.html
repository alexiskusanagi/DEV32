<?php
include("../utils/conectadb.php");
include("../utils/valida_cliente.php");

$sql = "SELECT AG_ID, AG_DATA, AG_HORA, AG_STATUS, CAT_NOME, CAT_PRECO, CAT_TEMPO 
        FROM agenda 
        INNER JOIN catalogo ON FK_CAT_ID = CAT_ID 
        WHERE FK_CLI_ID = $idcliente 
        ORDER BY AG_DATA DESC, AG_HORA ASC";

$resultado = mysqli_query($link, $sql);
?>

<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Minhas Reservas</title>
  <link rel="stylesheet" href="../css/global_cliente.css">
  <style>
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    .alterar { background-color: #ffeb3b; color: #000; padding: 6px 12px; border: none; cursor: pointer; }
    .cancelar { background-color: #f44336; color: #fff; padding: 6px 12px; border: none; cursor: pointer; }
    .bloqueado { color: #999; font-style: italic; }
  </style>
</head>
<body>
  <div class="global">
    <h2>Reservas de <?= strtoupper($nomecliente) ?></h2>

    <table>
      <tr>
        <th>ID</th>
        <th>Serviço</th>
        <th>Data</th>
        <th>Hora</th>
        <th>Status</th>
        <th>Duração</th>
        <th>Preço</th>
        <th>Ações</th>
      </tr>

      <?php while ($ag = mysqli_fetch_array($resultado)) {
        $agendamento = strtotime($ag['AG_DATA'] . ' ' . $ag['AG_HORA']);
        $agora = time();
        $tempoRestante = ($agendamento - $agora) / 60; // minutos
        $podeAlterarCancelar = $tempoRestante > 30;
      ?>
        <tr>
          <td><?= $ag['AG_ID'] ?></td>
          <td><?= htmlspecialchars($ag['CAT_NOME']) ?></td>
          <td><?= date("d/m/Y", strtotime($ag['AG_DATA'])) ?></td>
          <td><?= date("H:i", strtotime($ag['AG_HORA'])) ?></td>
          <td><?= $ag['AG_STATUS'] == '1' ? 'Confirmado' : 'Cancelado' ?></td>
          <td><?= $ag['CAT_TEMPO'] <= 59 ? $ag['CAT_TEMPO'] . " min" : number_format($ag['CAT_TEMPO']/60, 1) . " h" ?></td>
          <td>R$ <?= number_format($ag['CAT_PRECO'], 2, ',', '.') ?></td>
          <td>
            <?php if ($podeAlterarCancelar && $ag['AG_STATUS'] == '1') { ?>
              <form action="alterar_agendamento.php" method="post" style="display:inline;" onsubmit="return confirm('Deseja alterar esta reserva?');">
                <input type="hidden" name="id" value="<?= $ag['AG_ID'] ?>">
                <button type="submit" class="alterar">Alterar</button>
              </form>
              <form action="cancelar_agendamento.php" method="post" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja cancelar esta reserva?');">
                <input type="hidden" name="id" value="<?= $ag['AG_ID'] ?>">
                <button type="submit" class="cancelar">Cancelar</button>
              </form>
            <?php } else { ?>
              <span class="bloqueado">Alteração indisponível (menos de 30 min)</span>
            <?php } ?>
          </td>
        </tr>
      <?php } ?>
    </table>
  </div>
</body>
</html>
